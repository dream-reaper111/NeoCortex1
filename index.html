# ------------------ Static UI (robust) ------------------
from pathlib import Path
from fastapi.responses import RedirectResponse
from fastapi.staticfiles import StaticFiles

STATIC_DIR = Path(__file__).parent / "ui"
STATIC_DIR.mkdir(parents=True, exist_ok=True)

# create minimal UI if missing
index_path = STATIC_DIR / "index.html"
app_js_path = STATIC_DIR / "app.js"

if not index_path.exists():
    index_path.write_text("""
<!doctype html>
<html>
<head>
	<meta charset="utf-8" />
	<title>PineMimic Trader UI</title>
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<style>
		body {
			font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
			margin: 2rem;
		}

		.card {
			border: 1px solid #e5e7eb;
			border-radius: 12px;
			padding: 16px;
			max-width: 960px;
			box-shadow: 0 2px 10px rgba(0,0,0,0.04);
		}

		h1 {
			margin: 0 0 1rem 0;
		}

		label {
			display: block;
			margin: .5rem 0 .25rem;
			font-weight: 600;
		}

		input, select {
			padding: .5rem;
			width: 240px;
		}

		button {
			padding: .6rem 1rem;
			border-radius: 8px;
			border: 0;
			background: #3b82f6;
			color: #fff;
			cursor: pointer;
		}

			button:disabled {
				opacity: .6;
				cursor: not-allowed;
			}

		pre {
			background: #0b1020;
			color: #c9d1d9;
			padding: 12px;
			border-radius: 8px;
			overflow: auto;
		}
	</style>
</head>
<body>
	<div class="card">
		<h1>ðŸ“ˆ PineMimic Trader</h1>
		<p>Status: <span id="status">checkingâ€¦</span></p>

		<h2>Train</h2>
		<div>
			<label>Ticker</label>
			<input id="ticker" value="SPY" />
			<label>Period</label>
			<select id="period">
				<option>1mo</option>
				<option selected>6mo</option>
				<option>1y</option>
				<option>2y</option>
			</select>
			<label>Interval</label>
			<select id="interval">
				<option>5m</option>
				<option>15m</option>
				<option selected>1h</option>
				<option>1d</option>
			</select>
			<label>Max Iter</label>
			<input id="max_iter" type="number" value="200" />
		</div>
		<p><button id="trainBtn">Train</button></p>
		<pre id="trainOut"></pre>

		<h2>System Check</h2>
		<p><button id="checkBtn">Run /system-check</button></p>
		<pre id="sysOut"></pre>
	</div>

	<script src="/ui/app.js"></script>
</body>
</html>""", encoding="utf-8")

if not app_js_path.exists():
    app_js_path.write_text("""(function () {
  const $ = (id) => document.getElementById(id);

  async function getJSON(url, opts) {
    const r = await fetch(url, opts);
    if (!r.ok) throw new Error(await r.text());
    return await r.json();
  }

  async function boot() {
    try {
      const r = await getJSON('/preflight');
      $('status').textContent = r.overall_ok ? 'OK' : 'WARN (see /preflight)';
    } catch (e) {
      $('status').textContent = 'ERROR: ' + e.message;
    }
  }

  $('checkBtn').onclick = async () => {
    $('sysOut').textContent = 'â€¦';
    try {
      const r = await getJSON('/system-check');
      $('sysOut').textContent = JSON.stringify(r, null, 2);
    } catch (e) {
      $('sysOut').textContent = 'ERROR: ' + e.message;
    }
  };

  $('trainBtn').onclick = async () => {
    $('trainOut').textContent = 'Trainingâ€¦';
    const body = {
      ticker: $('ticker').value || 'SPY',
      period: $('period').value,
      interval: $('interval').value,
      max_iter: Number($('max_iter').value) || 200
    };
    try {
      const r = await getJSON('/train', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
      });
      $('trainOut').textContent = JSON.stringify(r, null, 2);
    } catch (e) {
      $('trainOut').textContent = 'ERROR: ' + e.message;
    }
  };

  boot();
})();""", encoding="utf-8")

# Mount with html=True so /ui/ serves index.html automatically
app.mount("/ui", StaticFiles(directory=str(STATIC_DIR), html=True), name="ui")

@app.get("/dashboard")
def dashboard():
    return RedirectResponse(url="/ui/")
