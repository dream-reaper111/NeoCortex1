{% extends 'base.html' %}
{% block title %}NeoCortex – Admin Access{% endblock %}
{% block body_class %}auth-layout{% endblock %}
{% block header %}{% endblock %}
{% block content %}
<section class="auth-page">
    <div class="auth-shell">
        <article class="auth-card" data-admin="true">
            <div class="auth-header">
                <span class="nc-pill auth-badge">Admin Access</span>
                <h1>Secure Operations Login</h1>
                <p class="auth-subtitle">Only authorized operators may access the NeoCortex administrative console. Multi-factor logging is enforced.</p>
            </div>
            <form id="loginForm" class="auth-form">
                <noscript class="auth-noscript">JavaScript must be enabled to authenticate securely.</noscript>
                <input type="hidden" id="csrf_token" name="csrf_token" />
                <div class="auth-field">
                    <label for="username">Username</label>
                    <input id="username" name="username" type="text" autocomplete="username" placeholder="admin" required />
                </div>
                <div class="auth-field">
                    <label for="password">Password</label>
                    <input id="password" name="password" type="password" autocomplete="current-password" placeholder="••••••••" required />
                </div>
                <div class="auth-field">
                    <label for="adminKey">Admin Private Key <span class="nc-text-muted">Required for account creation</span></label>
                    <input id="adminKey" name="adminKey" type="password" autocomplete="off" placeholder="Enter admin key" />
                </div>
                <div class="auth-options">
                    <label class="nc-checkbox" for="adminRemember"><input id="adminRemember" type="checkbox" /> Remember this device</label>
                    <a href="/login" class="auth-links">Member sign in</a>
                </div>
                <button type="submit" id="loginBtn" class="nc-btn">Sign In</button>
            </form>
            <div class="auth-actions">
                <button type="button" class="nc-btn nc-btn--secondary" id="registerBtn">Create Admin Account</button>
                <div id="message" class="auth-message"></div>
            </div>
            <footer class="auth-footer">
                Administrator accounts require hardware key approval. Contact security if your admin key has rotated.
            </footer>
        </article>
    </div>
</section>
{% endblock %}
{% block extra_scripts %}
<script defer>
    const TOKEN_KEY = 'nc_token';
    const USERNAME_KEY = 'nc_user';
    const COOKIE_NAME_KEY = 'nc_cookie';
    const REFRESH_KEY = 'nc_refresh';
    const params = new URLSearchParams(window.location.search);

    function resolveNext(candidate) {
        if (!candidate) { return '/dashboard'; }
        try {
            const parsed = new URL(candidate, window.location.origin);
            if (parsed.origin !== window.location.origin) {
                return '/dashboard';
            }
            return parsed.pathname + parsed.search + parsed.hash;
        } catch (_) {
            return '/dashboard';
        }
    }

    const rawNext = params.get('next');
    const nextUrl = resolveNext(rawNext);

    const sanitizedParams = new URLSearchParams();
    if (rawNext) {
        sanitizedParams.set('next', rawNext);
    }
    const sensitiveKeys = ['username', 'password', 'adminkey', 'adminKey'];
    let scrubbed = false;
    for (const key of sensitiveKeys) {
        if (params.has(key)) {
            scrubbed = true;
            break;
        }
    }
    const sanitizedQuery = sanitizedParams.toString();
    const desiredSearch = sanitizedQuery ? `?${sanitizedQuery}` : '';
    if (scrubbed || window.location.search !== desiredSearch) {
        const newUrl = desiredSearch ? `${window.location.pathname}${desiredSearch}` : window.location.pathname;
        window.history.replaceState(null, document.title, newUrl);
    }

    if (localStorage.getItem(TOKEN_KEY)) {
        window.location.replace(nextUrl);
    }

    if (!localStorage.getItem(COOKIE_NAME_KEY)) {
        localStorage.setItem(COOKIE_NAME_KEY, 'session_token');
    }

    const messageEl = document.getElementById('message');
    const usernameEl = document.getElementById('username');
    const passwordEl = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const adminKeyEl = document.getElementById('adminKey');

    function setMessage(text, type) {
        messageEl.textContent = text || '';
        messageEl.className = 'auth-message' + (type ? ' ' + type : '');
    }

    async function sendAuth(path, body) {
        const csrfToken = window.CSRF ? await window.CSRF.ensureToken() : null;
        const resp = await fetch(path, {
            method: 'POST',
            headers: Object.assign({ 'Content-Type': 'application/json' },
                csrfToken ? { [window.CSRF.headerName]: csrfToken } : {}),
            credentials: 'include',
            body: JSON.stringify(body)
        });
        const text = await resp.text();
        let data;
        try { data = JSON.parse(text); }
        catch (_) { throw new Error(`HTTP ${resp.status} ${resp.statusText}`); }
        if (!resp.ok || !data.ok) {
            throw new Error(data.detail || data.reason || 'Request failed');
        }
        return data;
    }

    document.getElementById('loginForm').addEventListener('submit', async (event) => {
        event.preventDefault();
        const username = usernameEl.value.trim().toLowerCase();
        const password = passwordEl.value;
        if (!username || !password) {
            setMessage('Enter a username and password to continue.', 'error');
            return;
        }
        loginBtn.disabled = true;
        registerBtn.disabled = true;
        setMessage('Signing you in…');
        try {
            const data = await sendAuth('/admin/login', { username, password, require_admin: true });
            const token = data.access_token || data.token;
            if (!token) {
                throw new Error('Login response missing access token');
            }
            localStorage.setItem(TOKEN_KEY, token);
            localStorage.setItem(USERNAME_KEY, data.username || username);
            if (data.refresh_token) {
                localStorage.setItem(REFRESH_KEY, data.refresh_token);
            } else {
                localStorage.removeItem(REFRESH_KEY);
            }
            const cookieName = data.session_cookie || localStorage.getItem(COOKIE_NAME_KEY) || 'session_token';
            localStorage.setItem(COOKIE_NAME_KEY, cookieName);
            setMessage('Success! Redirecting…', 'success');
            window.location.replace(nextUrl);
        } catch (err) {
            setMessage(err.message || 'Login failed', 'error');
        } finally {
            loginBtn.disabled = false;
            registerBtn.disabled = false;
        }
    });

    registerBtn.addEventListener('click', async () => {
        const username = usernameEl.value.trim().toLowerCase();
        const password = passwordEl.value;
        const adminKey = adminKeyEl.value.trim();
        if (!username || !password || !adminKey) {
            setMessage('Username, password, and admin key are required to register.', 'error');
            return;
        }
        loginBtn.disabled = true;
        registerBtn.disabled = true;
        setMessage('Registering admin…');
        try {
            const data = await sendAuth('/admin/register', { username, password, admin_key: adminKey });
            if (!data.ok) {
                throw new Error(data.detail || 'Registration failed');
            }
            setMessage('Admin account created. You can now sign in.', 'success');
        } catch (err) {
            setMessage(err.message || 'Registration failed', 'error');
        } finally {
            loginBtn.disabled = false;
            registerBtn.disabled = false;
        }
    });
</script>
{% endblock %}
