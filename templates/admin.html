{% extends 'base.html' %}
{% block title %}NeoCortex Control Center{% endblock %}
{% block content %}
<section class="admin-shell">
    <header class="admin-hero">
        <div class="nc-inline">
            <span class="nc-pill">Control Center</span>
            <span class="nc-pill">Welcome, {{ user.username }}</span>
        </div>
        <h1>Run the NeoCortex operations stack with confidence.</h1>
        <p class="nc-text-muted">
            Orchestrate training jobs, monitor ngrok connectivity, and review diagnostics before promoting new AI builds into production.
        </p>
        <div class="admin-meta">
            <span class="nc-pill">Roles: {{ (user.roles or ['user']) | join(', ') }}</span>
            <span class="nc-pill">Scopes: {{ (user.scopes or []) | join(', ') if user.scopes else '—' }}</span>
        </div>
    </header>

    <div class="nc-status-bar">
        <div class="nc-status-bar__item">
            <span class="nc-status-bar__label">GPU Status</span>
            <span class="nc-status-bar__value ok" id="gpuStatus">Loading…</span>
        </div>
        <div class="nc-status-bar__item">
            <span class="nc-status-bar__label">Last Training Run</span>
            <span class="nc-status-bar__value" id="runStatus">—</span>
        </div>
        <div class="nc-status-bar__item">
            <span class="nc-status-bar__label">Version</span>
            <span class="nc-status-bar__value" id="versionStatus">—</span>
        </div>
        <div class="nc-status-bar__item">
            <span class="nc-status-bar__label">Session</span>
            <span class="nc-status-bar__value" id="sessionStatus">Active</span>
        </div>
    </div>

    <section class="admin-grid">
        <article class="admin-card">
            <h2>Operations Dashboard</h2>
            <p class="nc-text-muted">Stream metrics, GPU telemetry, and active trainer status from the unified dashboard interface.</p>
            <a href="/dashboard" class="nc-btn">Open Dashboard</a>
        </article>
        <article class="admin-card">
            <h2>End User Console</h2>
            <p class="nc-text-muted">Guide clients through webhook configuration and funding setup using the end-user console.</p>
            <a href="/enduserapp" class="nc-btn nc-btn--secondary">Open End User App</a>
        </article>
        <article class="admin-card">
            <h2>Liquidity Radar</h2>
            <p class="nc-text-muted">Visualize aggregated sweep activity, dark pool sentiment, and imbalance warnings in real time.</p>
            <a href="/radar" class="nc-btn nc-btn--secondary">Open Liquidity Radar</a>
        </article>
        <article class="admin-card">
            <h2>Ngrok Tunnel</h2>
            <p class="nc-text-muted">Expose the NeoCortex stack securely. Share <code id="ngrokUrl">{{ request.url.hostname if request.url else '' }}</code> with trusted stakeholders.</p>
            <button type="button" class="nc-btn nc-btn--ghost" id="copyNgrok">Copy Public URL</button>
        </article>
    </section>

    <section class="admin-card">
        <h2>Platform Health</h2>
        <p class="nc-text-muted">Latest diagnostics pulled directly from the FastAPI backend.</p>
        <div class="admin-status-grid">
            <div class="admin-status">
                <span>GPU</span>
                <strong id="gpuStatusCard">Loading…</strong>
            </div>
            <div class="admin-status">
                <span>Recent Run</span>
                <strong id="runStatusCard">—</strong>
            </div>
            <div class="admin-status">
                <span>Version</span>
                <strong id="versionStatusCard">—</strong>
            </div>
            <div class="admin-status">
                <span>Auth Session</span>
                <strong id="sessionStatusCard">Active</strong>
            </div>
        </div>
        <div class="nc-text-small nc-text-muted" id="preflightSummary"></div>
    </section>

    <footer class="admin-footer">
        Navigation links are safe to share via your ngrok URL — all assets resolve from {{ request.url_for('public', path='') }}.
    </footer>
</section>
{% endblock %}
{% block extra_scripts %}
<script defer>
    const TOKEN_KEY = 'nc_token';

    function authToken() {
        return localStorage.getItem(TOKEN_KEY);
    }

    (function patchFetch() {
        const originalFetch = window.fetch.bind(window);
        window.fetch = async (input, init = {}) => {
            const token = authToken();
            const headers = new Headers(init.headers || {});
            if (token && !headers.has('Authorization')) {
                headers.set('Authorization', 'Bearer ' + token);
            }
            const requestMethod = init && init.method
                ? String(init.method)
                : (input && typeof input === 'object' && 'method' in input ? String(input.method) : 'GET');
            const method = requestMethod.toUpperCase();
            if (window.CSRF) {
                if (!['GET', 'HEAD', 'OPTIONS', 'TRACE'].includes(method)) {
                    try {
                        const csrfToken = await window.CSRF.ensureToken();
                        if (csrfToken) {
                            headers.set(window.CSRF.headerName, csrfToken);
                        }
                    } catch (err) {
                        console.warn('Unable to attach CSRF token', err);
                    }
                } else {
                    const csrfToken = window.CSRF.token();
                    if (csrfToken && !headers.has(window.CSRF.headerName)) {
                        headers.set(window.CSRF.headerName, csrfToken);
                    }
                }
            }
            const finalInit = Object.assign({}, init, { headers });
            if (!finalInit.credentials) {
                finalInit.credentials = 'include';
            }
            return originalFetch(input, finalInit);
        };
    })();

    function mirrorStatus(sourceId, targetId) {
        const src = document.getElementById(sourceId);
        const dest = document.getElementById(targetId);
        if (!src || !dest) return;
        dest.textContent = src.textContent;
        dest.className = src.className;
    }

    async function loadGpuStatus() {
        const el = document.getElementById('gpuStatus');
        const card = document.getElementById('gpuStatusCard');
        try {
            const resp = await fetch('/gpu-info', { cache: 'no-store' });
            const data = await resp.json();
            if (data.cuda_available) {
                const text = 'ONLINE (' + (data.devices || []).join(', ') + ')';
                el.textContent = text;
                el.classList.add('ok');
                card.textContent = text;
                card.classList.add('ok');
            } else {
                el.textContent = 'OFFLINE';
                el.classList.add('warn');
                card.textContent = 'Offline';
                card.classList.add('warn');
            }
        } catch (err) {
            el.textContent = 'Unknown';
            el.classList.add('warn');
            card.textContent = 'Unknown';
            card.classList.add('warn');
        }
    }

    async function loadPreflight() {
        const elRun = document.getElementById('runStatus');
        const elVersion = document.getElementById('versionStatus');
        const summary = document.getElementById('preflightSummary');
        const runCard = document.getElementById('runStatusCard');
        const versionCard = document.getElementById('versionStatusCard');
        try {
            const resp = await fetch('/preflight', { cache: 'no-store' });
            const data = await resp.json();
            const runText = data.last_training_run || 'No runs yet';
            const versionText = data.version || '—';
            elRun.textContent = runText;
            runCard.textContent = runText;
            elVersion.textContent = versionText;
            versionCard.textContent = versionText;
            summary.textContent = data.summary || 'Preflight diagnostics completed.';
        } catch (err) {
            elRun.textContent = 'Unavailable';
            runCard.textContent = 'Unavailable';
            elVersion.textContent = 'Unknown';
            versionCard.textContent = 'Unknown';
            summary.textContent = 'Unable to load preflight diagnostics.';
        }
    }

    (function initNgrokCopy() {
        const btn = document.getElementById('copyNgrok');
        if (!btn) return;
        btn.addEventListener('click', async () => {
            const url = window.location.origin;
            try {
                await navigator.clipboard.writeText(url);
                btn.textContent = 'Copied ' + url;
            } catch (_) {
                btn.textContent = url;
            }
        });
    })();

    function syncSession() {
        mirrorStatus('sessionStatus', 'sessionStatusCard');
    }

    loadGpuStatus();
    loadPreflight();
    syncSession();
</script>
{% endblock %}
