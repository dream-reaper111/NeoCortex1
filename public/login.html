<!doctype html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Neo Cortex AI – Sign In</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <style>
                :root {
                        --bg: #06090f;
                        --panel: #101726;
                        --border: #1b2535;
                        --accent: #3b82f6;
                        --text: #e6edf6;
                        --muted: #93a7c3;
                        --danger: #ff4d4f;
                        --success: #2ecc71;
                }

                * { box-sizing: border-box; }

                body {
                        margin: 0;
                        min-height: 100vh;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        background: radial-gradient(circle at top, rgba(59,130,246,0.25), transparent 55%), var(--bg);
                        color: var(--text);
                        font: 14px/1.5 "Segoe UI", system-ui, -apple-system, Roboto, sans-serif;
                        padding: 20px;
                }

                .card {
                        width: min(420px, 100%);
                        background: rgba(16, 23, 38, 0.92);
                        border: 1px solid rgba(59, 130, 246, 0.25);
                        border-radius: 16px;
                        padding: 28px 26px;
                        box-shadow: 0 20px 60px rgba(5, 12, 25, 0.45);
                        backdrop-filter: blur(12px);
                }

                h1 {
                        margin: 0 0 8px;
                        font-size: 26px;
                        letter-spacing: 0.3px;
                }

                p.subtitle {
                        margin: 0 0 24px;
                        color: var(--muted);
                        font-size: 13px;
                }

                label {
                        display: block;
                        font-size: 12px;
                        letter-spacing: 0.4px;
                        text-transform: uppercase;
                        color: var(--muted);
                        margin-bottom: 6px;
                }

                input[type="text"],
                input[type="password"],
                input[type="url"],
                select {
                        width: 100%;
                        padding: 10px 12px;
                        border-radius: 10px;
                        border: 1px solid var(--border);
                        background: rgba(7, 11, 19, 0.85);
                        color: var(--text);
                        outline: none;
                        transition: border-color 0.2s ease, box-shadow 0.2s ease;
                        margin-bottom: 16px;
                }

                input:focus {
                        border-color: rgba(59, 130, 246, 0.85);
                        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.18);
                }

                select {
                        appearance: none;
                        -webkit-appearance: none;
                        -moz-appearance: none;
                        background-image: linear-gradient(45deg, transparent 50%, rgba(230, 237, 246, 0.75) 50%),
                                linear-gradient(135deg, rgba(230, 237, 246, 0.75) 50%, transparent 50%),
                                linear-gradient(to right, rgba(7, 11, 19, 0.85), rgba(7, 11, 19, 0.85));
                        background-position: calc(100% - 16px) calc(50% - 3px), calc(100% - 11px) calc(50% - 3px), 100% 0;
                        background-size: 5px 5px, 5px 5px, 3.2rem 100%;
                        background-repeat: no-repeat;
                        padding-right: 42px;
                }

                button {
                        width: 100%;
                        padding: 12px 14px;
                        border: none;
                        border-radius: 10px;
                        background: linear-gradient(135deg, rgba(59,130,246,0.95), rgba(129,140,248,0.95));
                        color: #f8fbff;
                        font-weight: 600;
                        letter-spacing: 0.4px;
                        cursor: pointer;
                        transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.2s ease;
                }

                button:disabled {
                        cursor: wait;
                        opacity: 0.65;
                        box-shadow: none;
                }

                button:not(:disabled):hover {
                        transform: translateY(-1px);
                        box-shadow: 0 10px 28px rgba(59, 130, 246, 0.35);
                }

                .secondary {
                        margin-top: 12px;
                        background: rgba(16, 23, 38, 0.75);
                        border: 1px solid rgba(59, 130, 246, 0.35);
                        color: var(--text);
                }

                .secondary.whop {
                        border-style: dashed;
                        border-color: rgba(59, 130, 246, 0.55);
                        background: rgba(16, 23, 38, 0.6);
                        margin-top: 10px;
                }

                .message {
                        margin-top: 18px;
                        min-height: 24px;
                        font-size: 13px;
                }

                .message.error { color: var(--danger); }
                .message.success { color: var(--success); }

                .notice {
                        margin: 0 0 18px;
                        padding: 12px 14px;
                        border-radius: 10px;
                        border: 1px solid rgba(59, 130, 246, 0.4);
                        background: rgba(16, 23, 38, 0.8);
                        color: var(--text);
                        font-size: 13px;
                        line-height: 1.45;
                }

                .notice.error {
                        border-color: rgba(255, 77, 79, 0.55);
                        background: rgba(130, 30, 40, 0.35);
                }

                .notice.success {
                        border-color: rgba(46, 204, 113, 0.55);
                        background: rgba(23, 88, 52, 0.4);
                }

                .whop-extras {
                        margin-top: 8px;
                        padding: 12px;
                        border-radius: 12px;
                        border: 1px solid rgba(59, 130, 246, 0.25);
                        background: rgba(11, 17, 29, 0.85);
                }

                .whop-extras h2 {
                        margin: 0 0 8px;
                        font-size: 13px;
                        letter-spacing: 0.4px;
                        text-transform: uppercase;
                        color: rgba(147, 167, 195, 0.95);
                }

                .whop-extras label {
                        margin-top: 8px;
                }

                .fine-print {
                        margin-top: 24px;
                        color: rgba(147, 167, 195, 0.75);
                        font-size: 11px;
                        text-align: center;
                }
        </style>
</head>
<body>
        <div class="card">
                <h1>Neo Cortex AI</h1>
                <p class="subtitle">Members can sign in below. New access is available exclusively through Whop.</p>
                <p class="subtitle">Sign in to access the trading dashboard and manage your Alpaca keys.</p>

                <div id="whopNotice" class="notice" hidden></div>
                <form id="loginForm">
                        <label for="username">Username</label>
                        <input id="username" name="username" type="text" autocomplete="username" placeholder="yourname" required />
                        <label for="password">Password</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" placeholder="••••••••" required />
                        <div id="whopExtras" class="whop-extras" hidden>
                                <h2>Funding Credentials</h2>
                                <label for="accountType">Account Type</label>
                                <select id="accountType" name="accountType">
                                        <option value="funded">Funded (live)</option>
                                        <option value="paper">Paper</option>
                                </select>
                                <label for="apiKey">Alpaca API Key</label>
                                <input id="apiKey" name="apiKey" type="text" autocomplete="off" placeholder="PK..." />
                                <label for="apiSecret">Alpaca API Secret</label>
                                <input id="apiSecret" name="apiSecret" type="password" autocomplete="off" placeholder="SK..." />
                                <label for="baseUrl">API Base URL (optional)</label>
                                <input id="baseUrl" name="baseUrl" type="url" placeholder="https://api.alpaca.markets" />
                        </div>
                        <button type="submit" id="loginBtn">Sign In</button>
                </form>

                <button type="button" class="secondary whop" id="whopBtn">Continue with Whop</button>
                <button type="button" class="secondary" id="registerBtn" hidden>Complete Whop Registration</button>

                <button type="button" class="secondary" id="registerBtn">Create Account</button>
                <button type="button" class="secondary whop" id="whopBtn">Continue with Whop</button>

                <div id="message" class="message"></div>
                <div class="fine-print">Passwords are hashed with PBKDF2-SHA512 and never stored in plain text.</div>
        </div>

        <script>
                const TOKEN_KEY = 'nc_token';
                const USERNAME_KEY = 'nc_user';
                const COOKIE_NAME_KEY = 'nc_cookie';
                const params = new URLSearchParams(window.location.search);

                function resolveNext(candidate) {
                        if (!candidate) { return '/dashboard'; }
                        try {
                                const parsed = new URL(candidate, window.location.origin);
                                if (parsed.origin !== window.location.origin) {
                                        return '/dashboard';
                                }
                                return parsed.pathname + parsed.search + parsed.hash;
                        } catch (_) {
                                return '/dashboard';
                        }
                }

                const nextUrl = resolveNext(params.get('next'));

                if (localStorage.getItem(TOKEN_KEY)) {
                        window.location.replace(nextUrl);
                }

                if (!localStorage.getItem(COOKIE_NAME_KEY)) {
                        localStorage.setItem(COOKIE_NAME_KEY, 'session_token');
                }

                const messageEl = document.getElementById('message');
                const usernameEl = document.getElementById('username');
                const passwordEl = document.getElementById('password');
                const loginBtn = document.getElementById('loginBtn');
                const registerBtn = document.getElementById('registerBtn');
                const whopBtn = document.getElementById('whopBtn');

                if (registerBtn) {
                        registerBtn.hidden = true;
                        registerBtn.dataset.mode = '';
                }


                const whopNotice = document.getElementById('whopNotice');
                const whopExtras = document.getElementById('whopExtras');
                const accountTypeEl = document.getElementById('accountType');
                const apiKeyEl = document.getElementById('apiKey');
                const apiSecretEl = document.getElementById('apiSecret');
                const baseUrlEl = document.getElementById('baseUrl');

                function setMessage(text, type) {
                        messageEl.textContent = text || '';
                        messageEl.className = 'message' + (type ? ' ' + type : '');
                }

                function showWhopNotice(text, type) {
                        if (!text) {
                                whopNotice.textContent = '';
                                whopNotice.className = 'notice';
                                whopNotice.hidden = true;
                                return;
                        }
                        whopNotice.textContent = text;
                        whopNotice.className = 'notice' + (type ? ' ' + type : '');
                        whopNotice.hidden = false;
                }

                async function sendAuth(path, body) {
                        const resp = await fetch(path, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                credentials: 'include',
                                body: JSON.stringify(body)
                        });
                        const text = await resp.text();
                        let data;
                        try { data = JSON.parse(text); }
                        catch (_) { throw new Error(`HTTP ${resp.status} ${resp.statusText}`); }
                        if (!resp.ok || !data.ok) {
                                throw new Error(data.detail || data.reason || 'Request failed');
                        }
                        return data;
                }

                const whopToken = params.get('whop_token');
                let whopMode = false;
                let whopSessionValid = true;

                if (whopToken) {
                        whopMode = true;
                        whopExtras.hidden = false;

                        if (registerBtn) {
                                registerBtn.hidden = false;
                                registerBtn.textContent = 'Complete Whop Registration';
                                registerBtn.dataset.mode = 'whop';
                                registerBtn.disabled = true;
                        }

                        registerBtn.textContent = 'Complete Whop Registration';
                        registerBtn.dataset.mode = 'whop';
                        registerBtn.disabled = true;

                        if (whopBtn) { whopBtn.style.display = 'none'; }
                        showWhopNotice('Verifying your Whop membership…');
                        (async () => {
                                try {
                                        const resp = await fetch(`/auth/whop/session?token=${encodeURIComponent(whopToken)}`, {
                                                credentials: 'include'
                                        });
                                        const data = await resp.json();
                                        if (!resp.ok || !data.ok) {
                                                whopSessionValid = false;
                                                showWhopNotice(data.detail || 'Unable to verify your Whop session. Please restart from Whop.', 'error');
                                                return;
                                        }
                                        const email = data.email || '';
                                        const greeting = email ? `Welcome, ${email}!` : 'Whop membership verified!';
                                        showWhopNotice(`${greeting} Complete your funding credentials to finish setup.`, 'success');
                                        if (email && !usernameEl.value) {
                                                usernameEl.value = email.split('@')[0];
                                        }
                                        whopSessionValid = true;

                                        if (registerBtn) { registerBtn.disabled = false; }

                                        registerBtn.disabled = false;

                                } catch (err) {
                                        console.error(err);
                                        whopSessionValid = false;
                                        showWhopNotice('Unable to verify your Whop membership. Please restart from Whop.', 'error');
                                }
                        })();
                }

                if (whopBtn) {
                        whopBtn.addEventListener('click', () => {
                                const dest = '/auth/whop/start?next=' + encodeURIComponent(nextUrl);
                                window.location.href = dest;
                        });
                }

                document.getElementById('loginForm').addEventListener('submit', async (event) => {
                        event.preventDefault();
                        const username = usernameEl.value.trim().toLowerCase();
                        const password = passwordEl.value;
                        if (!username || !password) {
                                setMessage('Enter a username and password to continue.', 'error');
                                return;
                        }
                        loginBtn.disabled = true;
                        registerBtn.disabled = true;
                        setMessage('Signing you in…');
                        try {
                                const data = await sendAuth('/login', { username, password });
                                localStorage.setItem(TOKEN_KEY, data.token);
                                localStorage.setItem(USERNAME_KEY, data.username || username);
                                localStorage.setItem(COOKIE_NAME_KEY, data.session_cookie || 'session_token');
                                setMessage('Success! Redirecting…', 'success');
                                window.location.replace(nextUrl);
                        } catch (err) {
                                setMessage(err.message || 'Login failed', 'error');
                        } finally {
                                loginBtn.disabled = false;

                                if (registerBtn && registerBtn.dataset.mode === 'whop') {
                                        const lockRegister = !whopSessionValid;
                                        registerBtn.disabled = lockRegister;
                                }

                                const lockRegister = registerBtn.dataset.mode === 'whop' && !whopSessionValid;
                                registerBtn.disabled = lockRegister;

                        }
                });

                if (registerBtn) { registerBtn.addEventListener('click', async () => {
                        if (!whopMode) {
                                return;
                        }
                        const username = usernameEl.value.trim().toLowerCase();
                        const password = passwordEl.value;
                        if (!username || !password) {
                                setMessage('Choose a username and password before creating an account.', 'error');
                                return;
                        }
                        if (!whopSessionValid) {
                                setMessage('Your Whop session has expired. Start again from Whop.', 'error');
                                return;
                        }
                        const apiKey = apiKeyEl.value.trim();
                        const apiSecret = apiSecretEl.value.trim();
                        const baseUrl = baseUrlEl.value.trim();
                        if (!apiKey || !apiSecret) {
                                setMessage('Enter your Alpaca API key and secret to continue.', 'error');
                                return;
                        }
                        if (registerBtn.dataset.mode === 'whop') {
                                if (!whopSessionValid) {
                                        setMessage('Your Whop session has expired. Start again from Whop.', 'error');
                                        return;
                                }
                                const apiKey = apiKeyEl.value.trim();
                                const apiSecret = apiSecretEl.value.trim();
                                const baseUrl = baseUrlEl.value.trim();
                                if (!apiKey || !apiSecret) {
                                        setMessage('Enter your Alpaca API key and secret to continue.', 'error');
                                        return;
                                }
                                registerBtn.disabled = true;
                                loginBtn.disabled = true;
                                setMessage('Linking your Whop membership…');
                                try {
                                        const payload = {
                                                token: whopToken,
                                                username,
                                                password,
                                                api_key: apiKey,
                                                api_secret: apiSecret,
                                                account_type: (accountTypeEl.value || 'funded').toLowerCase(),
                                        };
                                        if (baseUrl) {
                                                payload.base_url = baseUrl;
                                        }
                                        const data = await sendAuth('/register/whop', payload);
                                        localStorage.setItem(TOKEN_KEY, data.token);
                                        localStorage.setItem(USERNAME_KEY, data.username || username);
                                        localStorage.setItem(COOKIE_NAME_KEY, data.session_cookie || 'session_token');
                                        setMessage('Welcome aboard! Redirecting…', 'success');
                                        window.location.replace(nextUrl);
                                } catch (err) {
                                        setMessage(err.message || 'Whop registration failed', 'error');
                                } finally {
                                        registerBtn.disabled = false;
                                        loginBtn.disabled = false;
                                }
                                return;
                        }
                        registerBtn.disabled = true;
                        loginBtn.disabled = true;
                        setMessage('Linking your Whop membership…');
                        try {
                                const payload = {
                                        token: whopToken,
                                        username,
                                        password,
                                        api_key: apiKey,
                                        api_secret: apiSecret,
                                        account_type: (accountTypeEl.value || 'funded').toLowerCase(),
                                };
                                if (baseUrl) {
                                        payload.base_url = baseUrl;
                                }
                                const data = await sendAuth('/register/whop', payload);
                                localStorage.setItem(TOKEN_KEY, data.token);
                                localStorage.setItem(USERNAME_KEY, data.username || username);
                                localStorage.setItem(COOKIE_NAME_KEY, data.session_cookie || 'session_token');
                                setMessage('Welcome aboard! Redirecting…', 'success');
                                window.location.replace(nextUrl);
                        } catch (err) {
                                setMessage(err.message || 'Whop registration failed', 'error');
                        } finally {
                                registerBtn.disabled = false;
                                loginBtn.disabled = false;
                        }
                }); }

                usernameEl.focus();
        </script>
</body>
</html>
